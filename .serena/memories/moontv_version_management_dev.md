# MoonTV 版本管理策略 - Dev 版本

> **文档版本**: dev (永久开发版本) | **更新日期**: 2025-10-14 | **策略类型**: 永久开发版本管理

## 🎯 版本管理哲学

### 核心理念

MoonTV 项目采用 **永久 dev 版本** 的版本管理哲学，专注于 Docker 镜像制作和企业级部署，与上游仓库保持独立管理。

**版本哲学**:

- 🚀 **开发优先**: dev 版本作为永久的开发标识
- 🔄 **持续迭代**: 无版本号限制的持续开发
- 🐳 **Docker 专注**: 专门用于 Docker 镜像制作
- 🏭 **企业就绪**: 生产级质量和稳定性

### 与传统版本管理的区别

```yaml
传统模式:
  - 版本号: v1.0.0 → v1.0.1 → v1.1.0 → v2.0.0
  - 发布周期: 固定版本发布
  - 开发模式: 版本驱动的开发
  - 变更管理: 严格的版本变更控制

MoonTV 模式:
  - 版本标识: dev (永久)
  - 发布模式: 持续集成和部署
  - 开发模式: 功能驱动的开发
  - 变更管理: 灵活的特性发布
```

## 📊 四版本系统详解

### 版本类型定义

```yaml
1. 开发版本 (Development Version)
  标识: dev
  用途: Docker 镜像制作开发环境标识
  管理: Git 标签管理
  特点: 永久不变，统一标识

2. 应用版本 (Application Version)
  标识: v3.2.0 (与上游同步)
  用途: 软件功能版本标识，用于版本更新检查
  管理: VERSION.txt + src/lib/version.ts
  特点: 与上游仓库完全一致

3. 生产版本 (Production Version)
  标识: v6.0.0 (按需创建)
  用途: 正式发布版本，生产环境部署
  管理: Git 标签 + 备份
  特点: 基于稳定功能创建

4. 测试镜像 (Test Image)
  标识: moontv:test
  用途: 生产就绪测试版本，功能验证
  管理: Docker Registry
  特点: 300MB 企业级优化
```

### 版本文件映射

| 文件/标签          | 版本类型   | 用途           | 当前值      | 更新机制     |
| ------------------ | ---------- | -------------- | ----------- | ------------ |
| Git 标签           | 开发版本   | 开发环境标识   | dev         | Git 标签管理 |
| VERSION.txt        | 应用版本   | 软件版本标识   | v3.2.0      | 上游同步     |
| src/lib/version.ts | 应用版本   | 代码版本常量   | v3.2.0      | 自动生成     |
| package.json       | NPM 包版本 | Node.js 包管理 | 0.1.0       | 开发维护     |
| moontv:test        | 测试镜像   | 生产就绪测试   | moontv:test | CI/CD 自动化 |

## 🔄 Dev 版本管理

### 永久 dev 版本特性

```yaml
版本标识:
  - 格式: dev (固定不变)
  - Git 标签: refs/tags/dev
  - 更新策略: 强制更新 (-f 参数)
  - 显示信息: "开发版本更新" + 提交信息

管理优势:
  - 简化认知: 无需记忆复杂版本号
  - 快速识别: 一眼识别开发环境
  - 统一标准: 所有开发环境使用相同标识
  - 易于维护: 减少版本管理复杂度
```

### Git 标签管理

```bash
# 更新开发版本标签
git tag -f dev -m "开发版本更新: [具体变更描述]"

# 查看开发版本状态
git show dev --stat

# 推送开发版本标签 (备份用)
git push origin dev -f

# 查看标签历史
git log --oneline --decorate --graph
```

### 分支管理策略

```yaml
主分支: main
  - 用途: 开发环境主分支
  - 标签: dev (始终指向最新提交)
  - 保护: 不可强制推送 (除了标签更新)

特性分支: feature/*
  - 用途: 新功能开发
  - 合并: 完成后合并到 main
  - 清理: 合并后删除分支

修复分支: fix/*
  - 用途: 问题修复
  - 合并: 修复后合并到 main
  - 优先级: 高优先级处理
```

## 📱 应用版本同步

### 上游同步策略

```yaml
同步原则:
  - 严格一致: VERSION.txt 与上游仓库保持一致
  - 自动检查: 定期检查上游版本更新
  - 及时同步: 发现更新后立即同步
  - 测试验证: 同步后进行功能测试

同步流程: 1. 监控上游仓库版本变化
  2. 下载最新的 VERSION.txt
  3. 更新 src/lib/version.ts
  4. 验证版本更新检查功能
  5. 提交变更并更新 dev 标签
```

### 版本更新检查机制

```yaml
检查逻辑:
  - 本地版本: 从 VERSION.txt 读取
  - 远程版本: 从上游仓库 API 获取
  - 比较策略: 语义版本比较
  - 显示状态: 主页显示更新提示

实现位置:
  - src/lib/version.ts: 版本常量定义
  - src/app/api/version/route.ts: 版本检查 API
  - src/components/UpdateNotice.tsx: 更新提示组件
```

## 🏭 生产版本管理

### 生产版本创建策略

```yaml
创建时机:
  - 功能完整: 核心功能开发完成
  - 测试通过: 全面测试验证通过
  - 性能达标: 性能指标达到要求
  - 文档完整: 相关文档更新完成

创建流程: 1. 功能验证和测试
  2. 性能基准测试
  3. 安全扫描和修复
  4. 文档更新和审查
  5. 创建生产版本标签
  6. 推送标签到远程仓库
```

### 生产版本标签管理

```bash
# 创建生产版本标签
git tag -a v6.0.0 -m "生产版本 v6.0.0

- 新特性: [列出主要新特性]
- 改进: [列出主要改进]
- 修复: [列出修复的问题]
- 性能: [性能优化说明]
- 安全: [安全增强说明]"

# 推送生产版本标签
git push origin v6.0.0

# 查看生产版本信息
git show v6.0.0 --stat

# 列出所有生产版本标签
git tag -l "v*" --sort=-version:refname
```

### 版本生命周期

```yaml
开发阶段:
  - 状态: dev (开发中)
  - 标签: dev (指向最新)
  - 部署: 开发环境

测试阶段:
  - 状态: v6.0.0-rc1 (候选版本)
  - 标签: v6.0.0-rc1
  - 部署: 测试环境

生产阶段:
  - 状态: v6.0.0 (稳定版本)
  - 标签: v6.0.0
  - 部署: 生产环境

维护阶段:
  - 状态: v6.0.x (维护版本)
  - 标签: v6.0.1, v6.0.2...
  - 部署: 生产环境 (热更新)
```

## 🐳 测试镜像管理

### 测试镜像版本策略

```yaml
镜像标识:
  - 名称: moontv:test
  - 版本: latest (默认)
  - 标签: 自动化标签管理
  - 更新: CI/CD 自动化更新

镜像特性:
  - 大小: 300MB (企业级优化)
  - 启动时间: <5秒 (极速启动)
  - 运行内存: ~32MB (轻量运行)
  - 功能完备: 所有端点测试通过
```

### 测试镜像自动化

```yaml
构建触发:
  - 代码提交: 自动构建和测试
  - PR 创建: 自动构建验证版本
  - 定时构建: 每日自动构建
  - 手动触发: 按需构建特定版本

测试流程: 1. 代码质量检查 (ESLint + TypeScript)
  2. 单元测试执行 (Jest)
  3. 集成测试 (API 端点测试)
  4. 构建测试镜像
  5. 功能验证测试
  6. 性能基准测试
  7. 安全扫描检查
  8. 推送到 Registry
```

### 测试镜像使用

```bash
# 拉取最新测试镜像
docker pull moontv:test

# 运行测试镜像
docker run -d -p 3000:3000 \
  -e PASSWORD=testpassword \
  --name moontv-test \
  moontv:test

# 访问测试环境
curl http://localhost:3000/api/health

# 停止测试容器
docker stop moontv-test
docker rm moontv-test
```

## 📋 版本配置管理

### 版本配置文件

```yaml
VERSION.txt:
  - 位置: 项目根目录
  - 内容: 应用版本号 (如 v3.2.0)
  - 用途: 版本检查和显示
  - 更新: 与上游同步

src/lib/version.ts:
  - 位置: 源代码目录
  - 内容: 版本常量定义
  - 用途: 代码中版本引用
  - 生成: 从 VERSION.txt 自动生成

package.json:
  - version 字段: 0.1.0 (开发维护)
  - 用途: NPM 包管理
  - 更新: 功能重大变更时更新

Docker 标签:
  - 开发标签: moontv:dev
  - 测试标签: moontv:test
  - 生产标签: moontv:v6.0.0
  - 时间标签: moontv:20251014
```

### 配置同步机制

```yaml
自动同步:
  - VERSION.txt → src/lib/version.ts
  - 触发: VERSION.txt 文件变更
  - 工具: 构建脚本自动生成
  - 验证: 启动时版本一致性检查

手动同步:
  - package.json 版本更新
  - Docker 标签管理
  - Git 标签更新
  - 文档版本信息更新
```

## 🔄 CI/CD 集成

### 持续集成流程

```yaml
代码提交:
  - 触发: Push 到 main 分支
  - 检查: 代码质量 + 测试
  - 构建: 开发环境构建
  - 标签: 更新 dev 标签

Pull Request:
  - 触发: PR 创建和更新
  - 验证: 全面测试验证
  - 构建: 测试镜像构建
  - 报告: 测试结果报告

定时任务:
  - 触发: 每日定时执行
  - 检查: 上游版本更新
  - 构建: 测试镜像更新
  - 通知: 变更通知发送
```

### 自动化部署

```yaml
开发环境:
  - 触发: main 分支更新
  - 部署: 开发环境自动部署
  - 验证: 健康检查和冒烟测试
  - 通知: 部署状态通知

测试环境:
  - 触发: PR 合并到 main
  - 部署: 测试环境自动部署
  - 测试: 自动化测试执行
  - 报告: 测试报告生成

生产环境:
  - 触发: 手动发布流程
  - 检查: 生产就绪检查
  - 部署: 生产环境部署
  - 监控: 部署后监控
```

## 📊 版本监控和报告

### 版本状态监控

```yaml
监控指标:
  - 当前版本: 各版本类型当前状态
  - 更新频率: 版本更新频率统计
  - 部署状态: 各环境部署状态
  - 性能指标: 版本性能对比

监控工具:
  - Git 标签监控: 标签创建和更新
  - Docker Registry: 镜像版本监控
  - 应用监控: 版本运行状态
  - 自动化报告: 定期版本报告
```

### 版本报告

```yaml
日报内容:
  - 开发进度: 当日开发进展
  - 版本变更: 版本相关变更
  - 测试状态: 测试执行情况
  - 部署状态: 部署和运行状态

周报内容:
  - 版本总结: 周版本变更总结
  - 功能进展: 功能开发进展
  - 质量指标: 代码质量指标
  - 性能分析: 性能变化分析

月报内容:
  - 版本回顾: 月度版本回顾
  - 里程碑达成: 重要里程碑
  - 技术债务: 技术债务状况
  - 下月计划: 下月版本规划
```

## 🚨 版本故障处理

### 常见版本问题

```yaml
版本冲突:
  - 问题: 本地版本与远程不一致
  - 解决: 同步远程标签和代码
  - 预防: 定期同步远程状态

版本回退:
  - 问题: 新版本出现严重问题
  - 解决: 回退到稳定版本标签
  - 预防: 充分测试后再发布

版本丢失:
  - 问题: 版本标签意外删除
  - 解决: 从备份恢复版本标签
  - 预防: 多重备份策略

版本混淆:
  - 问题: 不同版本类型混淆
  - 解决: 明确版本类型定义
  - 预防: 清晰的版本管理规范
```

### 应急响应流程

```yaml
问题识别:
  - 监控告警: 自动监控发现异常
  - 用户反馈: 用户报告版本问题
  - 定期检查: 主动版本状态检查
  - 测试验证: 版本功能测试

问题评估:
  - 影响范围: 确定问题影响范围
  - 严重程度: 评估问题严重程度
  - 解决方案: 制定解决方案
  - 时间估算: 评估修复时间

问题解决:
  - 紧急修复: 快速修复严重问题
  - 版本回退: 必要时回退版本
  - 重新发布: 修复后重新发布
  - 验证测试: 全面验证修复效果
```

## 🔮 版本管理未来发展

### 策略优化

```yaml
自动化增强:
  - 智能版本检测: AI 驱动的版本变更检测
  - 自动版本同步: 更智能的上游同步
  - 预测性版本管理: 基于历史数据预测版本需求
  - 自适应版本策略: 根据项目状态调整版本策略

工具集成:
  - IDE 集成: 与开发环境深度集成
  - CI/CD 增强: 更强大的 CI/CD 集成
  - 监控集成: 与运维监控系统集成
  - 协作集成: 与团队协作工具集成
```

### 流程改进

```yaml
质量提升:
  - 更严格的版本检查流程
  - 更全面的功能验证
  - 更精细的性能监控
  - 更及时的问题响应

效率提升:
  - 更快的版本发布流程
  - 更智能的版本管理工具
  - 更自动化的同步机制
  - 更清晰的版本文档
```

---

**版本管理特点**: 简化高效、持续迭代、企业级标准
**管理策略**: 永久 dev 版本 + 灵活生产版本 + 自动化测试
**文档更新**: 2025-10-14
**版本**: dev (永久开发版本)
