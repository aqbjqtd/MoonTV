# MoonTV è¿ç»´æŒ‡å—

**è®°å¿†ç±»å‹**: è¿ç»´æŒ‡å—  
**åˆ›å»ºæ—¶é—´**: 2025-12-12  
**æœ€åæ›´æ–°**: 2025-12-12  
**ç‰ˆæœ¬**: v1.0.0  
**é‡è¦æ€§**: é«˜  
**ç›¸å…³è®°å¿†**: éƒ¨ç½²é…ç½®, æŠ€æœ¯æ¶æ„, é¡¹ç›®æ¦‚è§ˆ  
**è¯­ä¹‰æ ‡ç­¾**: è¿ç»´ç®¡ç†, ç›‘æ§å‘Šè­¦, æ•…éšœæ’é™¤, å®‰å…¨ç»´æŠ¤, æ€§èƒ½ä¼˜åŒ–  
**ç´¢å¼•å…³é”®è¯**: è¿ç»´, ç›‘æ§, æ•…éšœå¤„ç†, å®‰å…¨, å¤‡ä»½, æ€§èƒ½è°ƒä¼˜, æ—¥å¿—åˆ†æ

## æ¦‚è¿°

MoonTV é¡¹ç›®çš„è¿ç»´ç®¡ç†æŒ‡å—ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç›‘æ§ã€æ•…éšœæ’é™¤ã€å®‰å…¨ç»´æŠ¤ã€æ€§èƒ½ä¼˜åŒ–ã€å¤‡ä»½æ¢å¤ç­‰è¿ç»´ç›¸å…³çš„æœ€ä½³å®è·µå’Œæ“ä½œæµç¨‹ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œã€‚

## è¿ç»´ä½“ç³»æ¶æ„

### è¿ç»´å±‚çº§ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç›‘æ§å‘Šè­¦å±‚                        â”‚
â”‚       ç³»ç»Ÿç›‘æ§ â”‚ ä¸šåŠ¡ç›‘æ§ â”‚ å®‰å…¨ç›‘æ§ â”‚ æ—¥å¿—ç›‘æ§     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   è¿ç»´æ“ä½œå±‚                        â”‚
â”‚       æ—¥å¸¸ç»´æŠ¤ â”‚ æ•…éšœå¤„ç† â”‚ æ€§èƒ½ä¼˜åŒ– â”‚ å®‰å…¨è¿ç»´     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   åŸºç¡€è®¾æ–½å±‚                        â”‚
â”‚       è®¡ç®—èµ„æº â”‚ å­˜å‚¨èµ„æº â”‚ ç½‘ç»œèµ„æº â”‚ å®‰å…¨èµ„æº     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿ç»´èŒè´£åˆ’åˆ†

#### 1. ç³»ç»Ÿè¿ç»´

- æœåŠ¡å™¨å’Œèµ„æºç®¡ç†
- ç³»ç»Ÿç›‘æ§å’Œæ€§èƒ½è°ƒä¼˜
- å¤‡ä»½å’Œæ¢å¤ç®¡ç†
- å®¹é‡è§„åˆ’å’Œæ‰©å±•

#### 2. åº”ç”¨è¿ç»´

- åº”ç”¨éƒ¨ç½²å’Œå‘å¸ƒ
- åº”ç”¨ç›‘æ§å’Œæ—¥å¿—ç®¡ç†
- æ•…éšœè¯Šæ–­å’Œå¤„ç†
- é…ç½®ç®¡ç†å’Œå˜æ›´æ§åˆ¶

#### 3. å®‰å…¨è¿ç»´

- å®‰å…¨ç›‘æ§å’Œæ¼æ´ç®¡ç†
- è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†
- å®‰å…¨äº‹ä»¶å“åº”
- åˆè§„æ€§æ£€æŸ¥

#### 4. æ•°æ®è¿ç»´

- æ•°æ®å¤‡ä»½å’Œæ¢å¤
- æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
- æ•°æ®è¿ç§»å’ŒåŒæ­¥
- æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤

## ç›‘æ§ç³»ç»Ÿé…ç½®

### ç›‘æ§æŒ‡æ ‡åˆ†ç±»

#### ç³»ç»Ÿå±‚ç›‘æ§

```yaml
# ç³»ç»Ÿèµ„æºç›‘æ§
cpu_usage:
  threshold: 80%
  alert_level: warning
  collection_interval: 60s

memory_usage:
  threshold: 85%
  alert_level: warning
  collection_interval: 60s

disk_usage:
  threshold: 90%
  alert_level: critical
  collection_interval: 300s

network_io:
  threshold: 100MB/s
  alert_level: warning
  collection_interval: 30s
```

#### åº”ç”¨å±‚ç›‘æ§

```yaml
# åº”ç”¨æ€§èƒ½ç›‘æ§
response_time:
  p95_threshold: 1000ms
  alert_level: warning
  collection_interval: 30s

error_rate:
  threshold: 1%
  alert_level: critical
  collection_interval: 60s

throughput:
  threshold: 1000rps
  alert_level: warning
  collection_interval: 30s

availability:
  threshold: 99.9%
  alert_level: critical
  collection_interval: 300s
```

#### ä¸šåŠ¡å±‚ç›‘æ§

```yaml
# ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
active_users:
  threshold: 1000
  alert_level: info
  collection_interval: 300s

search_requests:
  threshold: 100/min
  alert_level: warning
  collection_interval: 60s

play_requests:
  threshold: 500/min
  alert_level: warning
  collection_interval: 60s

concurrent_connections:
  threshold: 1000
  alert_level: critical
  collection_interval: 30s
```

### ç›‘æ§å·¥å…·é…ç½®

#### ä½¿ç”¨ Prometheus + Grafana

```yaml
# prometheus.yml é…ç½®ç¤ºä¾‹
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'moontv-app'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/api/metrics'

  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:6379']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
```

#### ç›‘æ§é¢æ¿é…ç½®

```javascript
// Grafana é¢æ¿é…ç½®
const dashboard = {
  title: 'MoonTV ç›‘æ§é¢æ¿',
  panels: [
    {
      title: 'CPU ä½¿ç”¨ç‡',
      type: 'graph',
      targets: [
        {
          expr: '100 - (avg by(instance)(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)',
        },
      ],
      thresholds: [80, 90],
    },
    {
      title: 'å†…å­˜ä½¿ç”¨ç‡',
      type: 'graph',
      targets: [
        {
          expr: '(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100',
        },
      ],
      thresholds: [85, 95],
    },
    {
      title: 'åº”ç”¨å“åº”æ—¶é—´',
      type: 'graph',
      targets: [
        {
          expr: 'histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))',
        },
      ],
      unit: 's',
    },
  ],
};
```

### æ—¥å¿—ç›‘æ§é…ç½®

#### æ—¥å¿—çº§åˆ«é…ç½®

```typescript
// æ—¥å¿—çº§åˆ«é…ç½®
const logLevels = {
  development: 'debug',
  test: 'info',
  production: 'warn',
};

// ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
const loggerConfig = {
  level: logLevels[process.env.NODE_ENV] || 'info',
  format: process.env.NODE_ENV === 'production' ? 'json' : 'pretty',
  transports: [
    new transports.Console(),
    new transports.File({ filename: 'logs/error.log', level: 'error' }),
    new transports.File({ filename: 'logs/combined.log' }),
  ],
};
```

#### æ—¥å¿—æ”¶é›†å’Œåˆ†æ

```bash
# ä½¿ç”¨ ELK æ ˆè¿›è¡Œæ—¥å¿—æ”¶é›†
# Filebeat é…ç½®
filebeat.inputs:
- type: log
  paths:
    - /var/log/moontv/*.log
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "moontv-logs-%{+yyyy.MM.dd}"
```

## æ—¥å¸¸ç»´æŠ¤æ“ä½œ

### æ¯æ—¥æ£€æŸ¥æ¸…å•

#### ç³»ç»Ÿå¥åº·æ£€æŸ¥

```bash
# 1. ç³»ç»Ÿèµ„æºæ£€æŸ¥
top -bn1 | head -20
free -h
df -h

# 2. æœåŠ¡çŠ¶æ€æ£€æŸ¥
systemctl status moontv
systemctl status redis
systemctl status nginx

# 3. åº”ç”¨å¥åº·æ£€æŸ¥
curl -f http://localhost:3000/api/health
curl -f http://localhost:3000/api/health/db
curl -f http://localhost:3000/api/health/redis

# 4. æ—¥å¿—æ£€æŸ¥
tail -100 /var/log/moontv/error.log
tail -100 /var/log/moontv/access.log
```

#### ä¸šåŠ¡æŒ‡æ ‡æ£€æŸ¥

```bash
# 1. ç”¨æˆ·æ´»è·ƒåº¦æ£€æŸ¥
redis-cli GET stats:daily_active_users

# 2. æœç´¢é‡æ£€æŸ¥
redis-cli GET stats:daily_search_count

# 3. æ’­æ”¾é‡æ£€æŸ¥
redis-cli GET stats:daily_play_count

# 4. é”™è¯¯ç‡æ£€æŸ¥
grep -c "ERROR" /var/log/moontv/error.log
```

### æ¯å‘¨ç»´æŠ¤ä»»åŠ¡

#### ç³»ç»Ÿç»´æŠ¤

```bash
# 1. ç³»ç»Ÿæ›´æ–°
sudo apt update
sudo apt upgrade -y

# 2. å®‰å…¨è¡¥ä¸
sudo unattended-upgrade --dry-run

# 3. æ—¥å¿—è½®è½¬å’Œæ¸…ç†
logrotate -f /etc/logrotate.d/moontv
find /var/log/moontv -name "*.log.*" -mtime +30 -delete

# 4. å¤‡ä»½éªŒè¯
./scripts/verify-backup.sh
```

#### åº”ç”¨ç»´æŠ¤

```bash
# 1. ä¾èµ–åŒ…æ›´æ–°æ£€æŸ¥
npm outdated
pnpm outdated

# 2. æ•°æ®åº“ä¼˜åŒ–
redis-cli --stat
redis-cli INFO memory

# 3. ç¼“å­˜æ¸…ç†
redis-cli FLUSHDB  # è°¨æ…ä½¿ç”¨

# 4. æ€§èƒ½åˆ†æ
node --prof app.js
node --prof-process isolate-0x*.log > processed.txt
```

### æ¯æœˆç»´æŠ¤ä»»åŠ¡

#### æ·±åº¦æ£€æŸ¥å’Œä¼˜åŒ–

```bash
# 1. å®‰å…¨å®¡è®¡
npm audit
snyk test

# 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
ab -n 1000 -c 100 http://localhost:3000/
siege -c 100 -t 60S http://localhost:3000/

# 3. å®¹é‡è§„åˆ’åˆ†æ
./scripts/analyze-capacity.sh

# 4. å¤‡ä»½ç­–ç•¥å®¡æŸ¥
./scripts/review-backup-policy.sh
```

#### æ•°æ®ç»´æŠ¤

```bash
# 1. æ•°æ®åº“ä¼˜åŒ–
redis-cli BGREWRITEAOF
redis-cli BGSAVE

# 2. æ•°æ®å½’æ¡£
./scripts/archive-old-data.sh

# 3. ç»Ÿè®¡æŠ¥å‘Šç”Ÿæˆ
./scripts/generate-monthly-report.sh

# 4. ç”¨æˆ·æ•°æ®æ¸…ç†
./scripts/cleanup-inactive-users.sh
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§æ•…éšœåˆ†ç±»

#### 1. ç³»ç»Ÿçº§æ•…éšœ

- æœåŠ¡å™¨å®•æœºæˆ–é‡å¯
- ç£ç›˜ç©ºé—´ä¸è¶³
- å†…å­˜æ³„æ¼æˆ–æº¢å‡º
- ç½‘ç»œè¿æ¥é—®é¢˜

#### 2. åº”ç”¨çº§æ•…éšœ

- åº”ç”¨å´©æºƒæˆ–æ— æ³•å¯åŠ¨
- æœåŠ¡å“åº”ç¼“æ…¢
- åŠŸèƒ½å¼‚å¸¸æˆ–é”™è¯¯
- æ•°æ®ä¸ä¸€è‡´é—®é¢˜

#### 3. æ•°æ®çº§æ•…éšœ

- æ•°æ®åº“è¿æ¥å¤±è´¥
- æ•°æ®ä¸¢å¤±æˆ–æŸå
- ç¼“å­˜å¤±æ•ˆæˆ–è¿‡æœŸ
- æ•°æ®åŒæ­¥é—®é¢˜

#### 4. å®‰å…¨çº§æ•…éšœ

- æœªæˆæƒè®¿é—®
- æ•°æ®æ³„éœ²é£é™©
- æ¶æ„æ”»å‡»
- é…ç½®é”™è¯¯å¯¼è‡´çš„å®‰å…¨æ¼æ´

### æ•…éšœè¯Šæ–­æµç¨‹

#### ç¬¬ä¸€æ­¥ï¼šé—®é¢˜è¯†åˆ«

```bash
# å¿«é€Ÿæ£€æŸ¥å‘½ä»¤
./scripts/quick-check.sh

# è¾“å‡ºåŒ…å«ï¼š
# 1. ç³»ç»ŸçŠ¶æ€
# 2. æœåŠ¡çŠ¶æ€
# 3. ç½‘ç»œçŠ¶æ€
# 4. ç£ç›˜çŠ¶æ€
# 5. å†…å­˜çŠ¶æ€
```

#### ç¬¬äºŒæ­¥ï¼šæ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -200 /var/log/moontv/error.log
tail -200 /var/log/moontv/access.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u moontv --since "10 minutes ago"
journalctl -u redis --since "10 minutes ago"

# æŸ¥çœ‹ç½‘ç»œæ—¥å¿—
tail -100 /var/log/nginx/error.log
tail -100 /var/log/nginx/access.log
```

#### ç¬¬ä¸‰æ­¥ï¼šæ€§èƒ½åˆ†æ

```bash
# CPU ä½¿ç”¨åˆ†æ
top -p $(pgrep -f "node.*moontv")
htop

# å†…å­˜ä½¿ç”¨åˆ†æ
pmap -x $(pgrep -f "node.*moontv")
cat /proc/$(pgrep -f "node.*moontv")/status | grep -E "Vm|Rss"

# ç½‘ç»œè¿æ¥åˆ†æ
netstat -anp | grep :3000
ss -tulpn | grep :3000

# ç£ç›˜IOåˆ†æ
iotop -p $(pgrep -f "node.*moontv")
iostat -x 1
```

#### ç¬¬å››æ­¥ï¼šæ ¹æœ¬åŸå› åˆ†æ

```bash
# é”™è¯¯è¿½è¸ª
node --inspect app.js  # å¯ç”¨è°ƒè¯•æ¨¡å¼

# å†…å­˜åˆ†æ
node --inspect --inspect-brk app.js
# ä½¿ç”¨ Chrome DevTools è¿›è¡Œå†…å­˜åˆ†æ

# æ€§èƒ½å‰–æ
node --prof app.js
node --prof-process isolate-0x*.log > processed.txt
```

### å¸¸è§æ•…éšœè§£å†³æ–¹æ¡ˆ

#### æ•…éšœ 1ï¼šåº”ç”¨æ— æ³•å¯åŠ¨

##### ç—‡çŠ¶

- åº”ç”¨è¿›ç¨‹ä¸å­˜åœ¨
- ç«¯å£æœªè¢«å ç”¨
- å¯åŠ¨è„šæœ¬æ‰§è¡Œå¤±è´¥

##### è¯Šæ–­æ­¥éª¤

```bash
# 1. æ£€æŸ¥å¯åŠ¨å‘½ä»¤
which node
node --version
pnpm --version

# 2. æ£€æŸ¥ä¾èµ–
pnpm install --frozen-lockfile
pnpm typecheck

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
env | grep -E "NEXT_|REDIS|UPSTASH"

# 4. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :3000
lsof -i :3000
```

##### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ä¿®å¤ä¾èµ–é—®é¢˜
rm -rf node_modules
rm -f pnpm-lock.yaml
pnpm install

# 2. ä¿®å¤é…ç½®é—®é¢˜
cp .env.example .env.local
# ç¼–è¾‘ .env.local æ–‡ä»¶

# 3. ä¿®å¤ç«¯å£å†²çª
# ä¿®æ”¹ç«¯å£å·æˆ–åœæ­¢å ç”¨è¿›ç¨‹
export PORT=3001
# æˆ–
kill -9 $(lsof -ti:3000)

# 4. é‡æ–°å¯åŠ¨
pnpm build
pnpm start
```

#### æ•…éšœ 2ï¼šåº”ç”¨å“åº”ç¼“æ…¢

##### ç—‡çŠ¶

- é¡µé¢åŠ è½½æ—¶é—´é•¿
- API å“åº”å»¶è¿Ÿ
- ç”¨æˆ·æ“ä½œå¡é¡¿

##### è¯Šæ–­æ­¥éª¤

```bash
# 1. ç³»ç»Ÿèµ„æºæ£€æŸ¥
top -bn1 | head -20
free -h
df -h

# 2. ç½‘ç»œå»¶è¿Ÿæ£€æŸ¥
ping -c 10 localhost
curl -o /dev/null -s -w "%{time_total}\n" http://localhost:3000/

# 3. æ•°æ®åº“æ€§èƒ½æ£€æŸ¥
redis-cli INFO stats
redis-cli SLOWLOG GET 10

# 4. åº”ç”¨æ€§èƒ½åˆ†æ
curl http://localhost:3000/api/debug/profile
```

##### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
# åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
redis-cli SLOWLOG GET 10

# 2. å¢åŠ ç¼“å­˜ç­–ç•¥
# è°ƒæ•´ç¼“å­˜æ—¶é—´å’Œç­–ç•¥
export REDIS_CACHE_TTL=3600

# 3. ä¼˜åŒ–å‰ç«¯èµ„æº
# å¯ç”¨å‹ç¼©å’ŒCDN
export NEXT_COMPRESSION=true

# 4. æ°´å¹³æ‰©å±•
# å¢åŠ åº”ç”¨å®ä¾‹
docker-compose scale moontv=3
```

#### æ•…éšœ 3ï¼šæ•°æ®ä¸ä¸€è‡´

##### ç—‡çŠ¶

- ç”¨æˆ·æ•°æ®ä¸¢å¤±
- æ’­æ”¾è®°å½•ä¸åŒæ­¥
- æ”¶è—å†…å®¹ä¸ä¸€è‡´

##### è¯Šæ–­æ­¥éª¤

```bash
# 1. æ£€æŸ¥å­˜å‚¨åç«¯è¿æ¥
redis-cli PING
curl -f http://localhost:3000/api/health/db

# 2. æ£€æŸ¥æ•°æ®åŒæ­¥çŠ¶æ€
redis-cli INFO replication
redis-cli INFO persistence

# 3. æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸­çš„æ•°æ®æ“ä½œé”™è¯¯
grep -E "data.*error|sync.*failed" /var/log/moontv/error.log

# 4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
./scripts/check-data-integrity.sh
```

##### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ä¿®å¤æ•°æ®åŒæ­¥
# è§¦å‘æ•°æ®åŒæ­¥
curl -X POST http://localhost:3000/api/admin/sync/data

# 2. æ¢å¤å¤‡ä»½æ•°æ®
./scripts/restore-backup.sh latest

# 3. ä¿®å¤æŸåçš„æ•°æ®
./scripts/repair-corrupted-data.sh

# 4. é‡å»ºç´¢å¼•å’Œç¼“å­˜
redis-cli FLUSHDB
# æ³¨æ„ï¼šæ­¤æ“ä½œä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®
```

#### æ•…éšœ 4ï¼šå®‰å…¨äº‹ä»¶å“åº”

##### ç—‡çŠ¶

- å¼‚å¸¸è®¿é—®æ—¥å¿—
- æœªæˆæƒè®¿é—®å°è¯•
- æ•°æ®æ³„éœ²è¿¹è±¡
- ç³»ç»Ÿèµ„æºå¼‚å¸¸æ¶ˆè€—

##### è¯Šæ–­æ­¥éª¤

```bash
# 1. åˆ†æè®¿é—®æ—¥å¿—
grep -E "401|403|404" /var/log/moontv/access.log | head -50
grep "failed.*login" /var/log/moontv/access.log

# 2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ä¸­çš„å®‰å…¨äº‹ä»¶
journalctl -u moontv --since "1 hour ago" | grep -i "security|auth|fail"

# 3. ç½‘ç»œè¿æ¥åˆ†æ
netstat -anp | grep ESTABLISHED
ss -tulpn | grep -E ":3000|:6379"

# 4. èµ„æºä½¿ç”¨å¼‚å¸¸æ£€æŸ¥
ps aux --sort=-%cpu | head -10
ps aux --sort=-%mem | head -10
```

##### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ç«‹å³å“åº”æªæ–½
# ä¸´æ—¶å°ç¦å¯ç–‘IP
iptables -A INPUT -s 1.2.3.4 -j DROP

# 2. å¢å¼ºå®‰å…¨é…ç½®
# æ›´æ–°é˜²ç«å¢™è§„åˆ™
ufw enable
ufw allow 22/tcp
ufw allow 3000/tcp

# 3. é‡ç½®å—å½±å“å‡­è¯
# é‡ç½®ç®¡ç†å‘˜å¯†ç 
export PASSWORD=new_strong_password_123!

# 4. å¯ç”¨é¢å¤–ç›‘æ§
# å¯ç”¨è¯¦ç»†çš„å®‰å…¨æ—¥å¿—
export SECURITY_LOG_LEVEL=debug
```

### æ•…éšœæ¢å¤æµç¨‹

#### æ ‡å‡†æ¢å¤æµç¨‹

```bash
# æ¢å¤æµç¨‹è„šæœ¬
#!/bin/bash
# restore-procedure.sh

set -e

echo "å¼€å§‹æ•…éšœæ¢å¤æµç¨‹..."

# 1. ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
echo "=== æ­¥éª¤1: è¯„ä¼°æ•…éšœå½±å“ ==="
./scripts/assess-impact.sh

# 2. æ‰§è¡Œç´§æ€¥å¤„ç†æªæ–½
echo "=== æ­¥éª¤2: æ‰§è¡Œç´§æ€¥å¤„ç† ==="
./scripts/emergency-response.sh

# 3. æ¢å¤æœåŠ¡å’Œæ•°æ®
echo "=== æ­¥éª¤3: æ¢å¤æœåŠ¡ ==="
./scripts/restore-service.sh

# 4. éªŒè¯æ¢å¤æ•ˆæœ
echo "=== æ­¥éª¤4: éªŒè¯æ¢å¤ ==="
./scripts/verify-recovery.sh

# 5. è®°å½•æ•…éšœå’Œæ¢å¤è¿‡ç¨‹
echo "=== æ­¥éª¤5: è®°å½•è¿‡ç¨‹ ==="
./scripts/document-incident.sh

echo "æ•…éšœæ¢å¤æµç¨‹å®Œæˆ"
```

#### ç¾éš¾æ¢å¤è®¡åˆ’

```yaml
# disaster-recovery-plan.yaml
recovery_objectives:
  rto: 4å°æ—¶ # æ¢å¤æ—¶é—´ç›®æ ‡
  rpo: 1å°æ—¶ # æ¢å¤ç‚¹ç›®æ ‡

recovery_procedures:
  - phase: ç«‹å³å“åº”
    actions:
      - ç¡®è®¤ç¾éš¾èŒƒå›´
      - å¯åŠ¨åº”æ€¥å›¢é˜Ÿ
      - é€šçŸ¥ç›¸å…³äººå‘˜

  - phase: ç³»ç»Ÿæ¢å¤
    actions:
      - å¯åŠ¨å¤‡ç”¨ç¯å¢ƒ
      - æ¢å¤æœ€æ–°å¤‡ä»½
      - éªŒè¯ç³»ç»ŸåŠŸèƒ½

  - phase: ä¸šåŠ¡æ¢å¤
    actions:
      - åˆ‡æ¢æµé‡åˆ°æ¢å¤ç¯å¢ƒ
      - ç›‘æ§ç³»ç»Ÿç¨³å®šæ€§
      - é€æ­¥æ¢å¤ä¸šåŠ¡åŠŸèƒ½

  - phase: äº‹åå¤„ç†
    actions:
      - åˆ†æç¾éš¾åŸå› 
      - æ”¹è¿›é¢„é˜²æªæ–½
      - æ›´æ–°æ¢å¤è®¡åˆ’
```

## å®‰å…¨è¿ç»´æŒ‡å—

### å®‰å…¨åŸºçº¿é…ç½®

#### ç³»ç»Ÿå®‰å…¨é…ç½®

```bash
# 1. é˜²ç«å¢™é…ç½®
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 3000/tcp # åº”ç”¨ç«¯å£
sudo ufw allow 80/tcp   # HTTP (å¦‚æœä½¿ç”¨Nginx)
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable

# 2. SSHå®‰å…¨é…ç½®
sudo vim /etc/ssh/sshd_config
# ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š
# Port 2222                    # ä¿®æ”¹é»˜è®¤ç«¯å£
# PermitRootLogin no           # ç¦æ­¢rootç™»å½•
# PasswordAuthentication no    # ä½¿ç”¨å¯†é’¥è®¤è¯
# MaxAuthTries 3              # æœ€å¤§å°è¯•æ¬¡æ•°
sudo systemctl restart sshd

# 3. ç³»ç»Ÿæ›´æ–°é…ç½®
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
```

#### åº”ç”¨å®‰å…¨é…ç½®

```bash
# 1. ç¯å¢ƒå˜é‡å®‰å…¨é…ç½®
# ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®çš„å˜é‡
export PASSWORD=strong_password_123!
export JWT_SECRET=random_jwt_secret_key
export ENCRYPTION_KEY=encryption_key_for_sensitive_data

# 2. ç¦ç”¨ä¸å¿…è¦åŠŸèƒ½
export NEXT_PUBLIC_ENABLE_REGISTER=false
export DEBUG=false
export NODE_ENV=production

# 3. å®‰å…¨å¤´éƒ¨é…ç½®
# next.config.js ä¸­çš„å®‰å…¨é…ç½®
headers: [
  {
    source: '/(.*)',
    headers: [
      { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
      { key: 'X-Content-Type-Options', value: 'nosniff' },
      { key: 'X-XSS-Protection', value: '1; mode=block' },
      { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' }
    ]
  }
]
```

### å®‰å…¨ç›‘æ§å’Œå‘Šè­¦

#### å®‰å…¨äº‹ä»¶ç›‘æ§

```yaml
# å®‰å…¨ç›‘æ§è§„åˆ™é…ç½®
security_monitoring:
  # è®¤è¯å¤±è´¥ç›‘æ§
  auth_failures:
    threshold: 10
    time_window: 5åˆ†é’Ÿ
    alert_level: warning
    action: ä¸´æ—¶å°ç¦IP

  # å¼‚å¸¸è®¿é—®æ¨¡å¼
  abnormal_access:
    threshold: 1000è¯·æ±‚/åˆ†é’Ÿ
    time_window: 1åˆ†é’Ÿ
    alert_level: critical
    action: ç«‹å³è°ƒæŸ¥

  # æ•°æ®æ³„éœ²è¿¹è±¡
  data_leakage:
    patterns:
      - 'password.*exposed'
      - 'token.*leaked'
      - 'credentials.*public'
    alert_level: critical
    action: ç«‹å³å“åº”
```

#### å®‰å…¨æ—¥å¿—é…ç½®

```typescript
// å®‰å…¨æ—¥å¿—è®°å½•é…ç½®
const securityLogger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'moontv-security' },
  transports: [
    new transports.File({
      filename: 'logs/security.log',
      level: 'info',
    }),
    new transports.File({
      filename: 'logs/security-error.log',
      level: 'error',
    }),
  ],
});

// è®°å½•å®‰å…¨äº‹ä»¶
function logSecurityEvent(event: SecurityEvent) {
  securityLogger.info('å®‰å…¨äº‹ä»¶', {
    timestamp: new Date().toISOString(),
    eventType: event.type,
    severity: event.severity,
    sourceIp: event.sourceIp,
    userId: event.userId,
    details: event.details,
  });

  // è§¦å‘å‘Šè­¦
  if (event.severity === 'critical') {
    sendSecurityAlert(event);
  }
}
```

### å®‰å…¨å®¡è®¡å’Œåˆè§„

#### å®šæœŸå®‰å…¨å®¡è®¡

```bash
# æœˆåº¦å®‰å…¨å®¡è®¡è„šæœ¬
#!/bin/bash
# security-audit.sh

echo "å¼€å§‹æœˆåº¦å®‰å…¨å®¡è®¡..."

# 1. æ¼æ´æ‰«æ
echo "=== æ¼æ´æ‰«æ ==="
npm audit
snyk test
trivy image moontv:latest

# 2. é…ç½®å®¡è®¡
echo "=== é…ç½®å®¡è®¡ ==="
./scripts/audit-config.sh
./scripts/check-permissions.sh

# 3. æ—¥å¿—å®¡è®¡
echo "=== æ—¥å¿—å®¡è®¡ ==="
./scripts/audit-logs.sh

# 4. è®¿é—®å®¡è®¡
echo "=== è®¿é—®å®¡è®¡ ==="
./scripts/audit-access.sh

# 5. ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
echo "=== ç”ŸæˆæŠ¥å‘Š ==="
./scripts/generate-audit-report.sh

echo "å®‰å…¨å®¡è®¡å®Œæˆ"
```

#### åˆè§„æ€§æ£€æŸ¥

```bash
# GDPRåˆè§„æ€§æ£€æŸ¥
./scripts/check-gdpr-compliance.sh

# æ•°æ®ä¿æŠ¤æ£€æŸ¥
./scripts/check-data-protection.sh

# éšç§æ”¿ç­–æ£€æŸ¥
./scripts/check-privacy-policy.sh

# ç”¨æˆ·æ•°æ®å¤„ç†æ£€æŸ¥
./scripts/check-user-data-handling.sh
```

## æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

#### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI)

```yaml
performance_kpis:
  # å‰ç«¯æ€§èƒ½æŒ‡æ ‡
  frontend:
    first_contentful_paint:
      target: <1.5s
      threshold: 3s

    largest_contentful_paint:
      target: <2.5s
      threshold: 4s

    cumulative_layout_shift:
      target: <0.1
      threshold: 0.25

    first_input_delay:
      target: <100ms
      threshold: 300ms

  # åç«¯æ€§èƒ½æŒ‡æ ‡
  backend:
    api_response_time_p95:
      target: <200ms
      threshold: 500ms

    error_rate:
      target: <0.1%
      threshold: 1%

    throughput:
      target: >1000rps
      threshold: 100rps

    availability:
      target: >99.9%
      threshold: 99%
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### å‰ç«¯ä¼˜åŒ–

```javascript
// Next.js æ€§èƒ½ä¼˜åŒ–é…ç½®
// next.config.js
module.exports = {
  // å¯ç”¨å‹ç¼©
  compress: true,

  // å›¾ç‰‡ä¼˜åŒ–
  images: {
    formats: ['image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },

  // è„šæœ¬ä¼˜åŒ–
  experimental: {
    optimizeCss: true,
    scrollRestoration: true,
  },

  // ç¼“å­˜ç­–ç•¥
  headers: async () => [
    {
      source: '/_next/static/:path*',
      headers: [
        { key: 'Cache-Control', value: 'public, max-age=31536000, immutable' },
      ],
    },
  ],
};
```

#### åç«¯ä¼˜åŒ–

```typescript
// æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥
class DatabaseOptimizer {
  // æŸ¥è¯¢ä¼˜åŒ–
  async optimizeQueries(): Promise<void> {
    // 1. æ·»åŠ ç´¢å¼•
    await this.addIndexes();

    // 2. ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
    await this.optimizeQueryPatterns();

    // 3. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
    await this.optimizeCacheStrategy();

    // 4. è¿æ¥æ± ä¼˜åŒ–
    await this.optimizeConnectionPool();
  }

  // Redisä¼˜åŒ–
  async optimizeRedis(): Promise<void> {
    // å†…å­˜ä¼˜åŒ–
    await redis.configSet('maxmemory-policy', 'allkeys-lru');

    // æŒä¹…åŒ–ä¼˜åŒ–
    await redis.configSet('save', '900 1 300 10 60 10000');

    // è¿æ¥ä¼˜åŒ–
    await redis.configSet('tcp-keepalive', '300');
  }
}
```

#### ç½‘ç»œä¼˜åŒ–

```nginx
# Nginxä¼˜åŒ–é…ç½®
# /etc/nginx/nginx.conf
http {
  # åŸºç¡€ä¼˜åŒ–
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  # Gzipå‹ç¼©
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types
    application/javascript
    application/json
    application/xml
    text/css
    text/javascript
    text/plain
    text/xml;

  # ç¼“å­˜ä¼˜åŒ–
  open_file_cache max=1000 inactive=20s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  # å®‰å…¨å¤´éƒ¨
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
}
```

### å®¹é‡è§„åˆ’å’Œæ‰©å±•

#### å®¹é‡è¯„ä¼°æŒ‡æ ‡

```yaml
capacity_metrics:
  # ç”¨æˆ·å®¹é‡
  user_capacity:
    concurrent_users: 1000
    daily_active_users: 10000
    storage_per_user: 10MB

  # æ•°æ®å®¹é‡
  data_capacity:
    video_metadata: 100GB
    user_data: 50GB
    cache_data: 20GB

  # æ€§èƒ½å®¹é‡
  performance_capacity:
    requests_per_second: 1000
    bandwidth: 100Mbps
    connections: 5000

  # å­˜å‚¨å®¹é‡
  storage_capacity:
    total_disk: 200GB
    used_disk: 150GB
    free_disk: 50GB
```

#### æ‰©å±•ç­–ç•¥

```bash
# æ°´å¹³æ‰©å±•è„šæœ¬
#!/bin/bash
# scale-out.sh

set -e

echo "å¼€å§‹æ°´å¹³æ‰©å±•..."

# 1. è¯„ä¼°å½“å‰è´Ÿè½½
echo "=== è¯„ä¼°å½“å‰è´Ÿè½½ ==="
load=$(uptime | awk '{print $10}' | tr -d ',')
echo "å½“å‰è´Ÿè½½: $load"

# 2. æ£€æŸ¥èµ„æºä½¿ç”¨
echo "=== æ£€æŸ¥èµ„æºä½¿ç”¨ ==="
cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | tr -d '%')
memory=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}')
echo "CPUä½¿ç”¨ç‡: ${cpu}%"
echo "å†…å­˜ä½¿ç”¨ç‡: ${memory}%"

# 3. å†³å®šæ‰©å±•ç­–ç•¥
if [ $(echo "$load > 5" | bc) -eq 1 ] || [ $cpu -gt 80 ] || [ $memory -gt 80 ]; then
  echo "éœ€è¦æ‰©å±•"

  # 4. æ‰§è¡Œæ‰©å±•
  echo "=== æ‰§è¡Œæ‰©å±• ==="
  docker-compose up -d --scale moontv=3

  # 5. é…ç½®è´Ÿè½½å‡è¡¡
  echo "=== é…ç½®è´Ÿè½½å‡è¡¡ ==="
  ./scripts/configure-load-balancer.sh

else
  echo "å½“å‰è´Ÿè½½æ­£å¸¸ï¼Œæ— éœ€æ‰©å±•"
fi

echo "æ‰©å±•æ“ä½œå®Œæˆ"
```

## å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

### å¤‡ä»½ç­–ç•¥é…ç½®

#### æ•°æ®åˆ†ç±»å’Œå¤‡ä»½é¢‘ç‡

```yaml
backup_strategy:
  # å…³é”®æ•°æ® - é¢‘ç¹å¤‡ä»½
  critical_data:
    - user_profiles
    - play_records
    - favorites
    backup_frequency: æ¯å°æ—¶
    retention: 30å¤©
    encryption: å¯ç”¨

  # é‡è¦æ•°æ® - å®šæœŸå¤‡ä»½
  important_data:
    - video_metadata
    - source_configs
    - site_settings
    backup_frequency: æ¯å¤©
    retention: 90å¤©
    encryption: å¯ç”¨

  # ä¸€èˆ¬æ•°æ® - å¶å°”å¤‡ä»½
  general_data:
    - cache_data
    - logs
    - temp_files
    backup_frequency: æ¯å‘¨
    retention: 180å¤©
    encryption: å¯é€‰

  # ç³»ç»Ÿé…ç½® - å˜æ›´æ—¶å¤‡ä»½
  system_config:
    - environment_variables
    - nginx_config
    - docker_config
    backup_frequency: å˜æ›´æ—¶
    retention: æ°¸ä¹…
    encryption: å¯ç”¨
```

#### å¤‡ä»½è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# backup.sh

set -e

# é…ç½®
BACKUP_DIR="/backups/moontv"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

echo "å¼€å§‹å¤‡ä»½ $(date)"

# 1. åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR/$DATE"

# 2. å¤‡ä»½Redisæ•°æ®
echo "å¤‡ä»½Redisæ•°æ®..."
redis-cli SAVE
cp /var/lib/redis/dump.rdb "$BACKUP_DIR/$DATE/redis_dump.rdb"

# 3. å¤‡ä»½ç”¨æˆ·æ•°æ®
echo "å¤‡ä»½ç”¨æˆ·æ•°æ®..."
./scripts/export-user-data.sh > "$BACKUP_DIR/$DATE/user_data.json"

# 4. å¤‡ä»½é…ç½®
echo "å¤‡ä»½é…ç½®..."
cp .env "$BACKUP_DIR/$DATE/env.backup"
cp config.json "$BACKUP_DIR/$DATE/config.json"

# 5. å¤‡ä»½æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
echo "å¤‡ä»½é‡è¦æ—¥å¿—..."
tar -czf "$BACKUP_DIR/$DATE/logs.tar.gz" /var/log/moontv/*.log

# 6. åˆ›å»ºå¤‡ä»½æ¸…å•
echo "åˆ›å»ºå¤‡ä»½æ¸…å•..."
cat > "$BACKUP_DIR/$DATE/backup_manifest.json" << EOF
{
  "backup_date": "$(date -Iseconds)",
  "backup_type": "full",
  "components": ["redis", "user_data", "config", "logs"],
  "size": "$(du -sh "$BACKUP_DIR/$DATE" | cut -f1)"
}
EOF

# 7. åŠ å¯†å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
if [ "$ENABLE_ENCRYPTION" = "true" ]; then
  echo "åŠ å¯†å¤‡ä»½..."
  gpg --encrypt --recipient backup@moontv.com "$BACKUP_DIR/$DATE/backup_manifest.json"
fi

# 8. æ¸…ç†æ—§å¤‡ä»½
echo "æ¸…ç†æ—§å¤‡ä»½..."
find "$BACKUP_DIR" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \;

echo "å¤‡ä»½å®Œæˆ $(date)"
```

### æ¢å¤æµç¨‹

#### æ•°æ®æ¢å¤è„šæœ¬

```bash
#!/bin/bash
# restore.sh

set -e

# é…ç½®
BACKUP_DIR="/backups/moontv"
BACKUP_DATE="$1"  # ä¼ å…¥å¤‡ä»½æ—¥æœŸï¼Œå¦‚ 20251212_120000

if [ -z "$BACKUP_DATE" ]; then
  echo "è¯·æŒ‡å®šå¤‡ä»½æ—¥æœŸ"
  echo "ç”¨æ³•: $0 <å¤‡ä»½æ—¥æœŸ>"
  echo "å¯ç”¨å¤‡ä»½:"
  ls "$BACKUP_DIR"
  exit 1
fi

BACKUP_PATH="$BACKUP_DIR/$BACKUP_DATE"

if [ ! -d "$BACKUP_PATH" ]; then
  echo "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $BACKUP_PATH"
  exit 1
fi

echo "å¼€å§‹ä»å¤‡ä»½æ¢å¤: $BACKUP_DATE"

# 1. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
echo "=== éªŒè¯å¤‡ä»½å®Œæ•´æ€§ ==="
if [ -f "$BACKUP_PATH/backup_manifest.json.gpg" ]; then
  echo "éªŒè¯åŠ å¯†å¤‡ä»½..."
  gpg --verify "$BACKUP_PATH/backup_manifest.json.gpg"
fi

# 2. åœæ­¢æœåŠ¡
echo "=== åœæ­¢æœåŠ¡ ==="
docker-compose down

# 3. æ¢å¤Redisæ•°æ®
echo "=== æ¢å¤Redisæ•°æ® ==="
if [ -f "$BACKUP_PATH/redis_dump.rdb" ]; then
  cp "$BACKUP_PATH/redis_dump.rdb" /var/lib/redis/dump.rdb
  chown redis:redis /var/lib/redis/dump.rdb
fi

# 4. æ¢å¤ç”¨æˆ·æ•°æ®
echo "=== æ¢å¤ç”¨æˆ·æ•°æ® ==="
if [ -f "$BACKUP_PATH/user_data.json" ]; then
  ./scripts/import-user-data.sh < "$BACKUP_PATH/user_data.json"
fi

# 5. æ¢å¤é…ç½®
echo "=== æ¢å¤é…ç½® ==="
if [ -f "$BACKUP_PATH/env.backup" ]; then
  cp "$BACKUP_PATH/env.backup" .env
fi
if [ -f "$BACKUP_PATH/config.json" ]; then
  cp "$BACKUP_PATH/config.json" config.json
fi

# 6. å¯åŠ¨æœåŠ¡
echo "=== å¯åŠ¨æœåŠ¡ ==="
docker-compose up -d

# 7. éªŒè¯æ¢å¤
echo "=== éªŒè¯æ¢å¤ ==="
sleep 10
curl -f http://localhost:3000/api/health
curl -f http://localhost:3000/api/health/db

echo "æ¢å¤å®Œæˆ"
```

## è¿ç»´è‡ªåŠ¨åŒ–

### è‡ªåŠ¨åŒ–è„šæœ¬åº“

#### æ—¥å¸¸è¿ç»´è„šæœ¬

```bash
# scripts/ops/
# â”œâ”€â”€ daily-check.sh          # æ¯æ—¥æ£€æŸ¥
# â”œâ”€â”€ weekly-maintenance.sh   # æ¯å‘¨ç»´æŠ¤
# â”œâ”€â”€ monthly-audit.sh        # æ¯æœˆå®¡è®¡
# â”œâ”€â”€ backup.sh              # å¤‡ä»½è„šæœ¬
# â”œâ”€â”€ restore.sh             # æ¢å¤è„šæœ¬
# â”œâ”€â”€ scale-out.sh           # æ‰©å±•è„šæœ¬
# â”œâ”€â”€ scale-in.sh            # ç¼©å®¹è„šæœ¬
# â”œâ”€â”€ monitor-alert.sh       # ç›‘æ§å‘Šè­¦
# â””â”€â”€ security-scan.sh       # å®‰å…¨æ‰«æ
```

#### ç›‘æ§å‘Šè­¦è‡ªåŠ¨åŒ–

```bash
#!/bin/bash
# monitor-alert.sh

set -e

# é…ç½®
ALERT_THRESHOLDS=(
  "cpu_usage 80"
  "memory_usage 85"
  "disk_usage 90"
  "error_rate 1"
  "response_time 1000"
)

ALERT_CHANNELS=("slack" "email")

# è·å–ç›‘æ§æŒ‡æ ‡
function get_metric() {
  case $1 in
    "cpu_usage")
      top -bn1 | grep "Cpu(s)" | awk '{print $2}' | tr -d '%'
      ;;
    "memory_usage")
      free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}'
      ;;
    "disk_usage")
      df / | tail -1 | awk '{print $5}' | tr -d '%'
      ;;
    "error_rate")
      # ä»æ—¥å¿—ä¸­è®¡ç®—é”™è¯¯ç‡
      grep -c "ERROR" /var/log/moontv/error.log
      ;;
    "response_time")
      # ä»ç›‘æ§ç³»ç»Ÿè·å–å“åº”æ—¶é—´
      curl -s http://localhost:9090/api/v1/query?query=http_request_duration_seconds:rate5m | jq '.data.result[0].value[1]'
      ;;
  esac
}

# å‘é€å‘Šè­¦
function send_alert() {
  local metric=$1
  local value=$2
  local threshold=$3

  local message="ğŸš¨ ç›‘æ§å‘Šè­¦
æŒ‡æ ‡: $metric
å½“å‰å€¼: $value
é˜ˆå€¼: $threshold
æ—¶é—´: $(date)
ä¸»æœº: $(hostname)"

  # å‘é€åˆ°Slack
  if [[ " ${ALERT_CHANNELS[@]} " =~ " slack " ]]; then
    curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"$message\"}" \
      "$SLACK_WEBHOOK_URL"
  fi

  # å‘é€é‚®ä»¶
  if [[ " ${ALERT_CHANNELS[@]} " =~ " email " ]]; then
    echo "$message" | mail -s "MoonTVç›‘æ§å‘Šè­¦" "$ALERT_EMAIL"
  fi
}

# ä¸»ç›‘æ§å¾ªç¯
for threshold in "${ALERT_THRESHOLDS[@]}"; do
  read metric threshold_value <<< "$threshold"
  current_value=$(get_metric "$metric")

  if [ $(echo "$current_value > $threshold_value" | bc) -eq 1 ]; then
    echo "å‘Šè­¦: $metric = $current_value (é˜ˆå€¼: $threshold_value)"
    send_alert "$metric" "$current_value" "$threshold_value"
  fi
done
```

### Git æ“ä½œæ–¹å‘çš„æœ€ä½³å®è·µ

**æ‹‰å–/åŒæ­¥** (ä»ä¸Šæ¸¸åˆ°æœ¬åœ°)

- **å«ä¹‰**ï¼šæœ¬åœ° â† ä¸Šæ¸¸
- **æ“ä½œ**ï¼š`git fetch upstream` æˆ– `git pull upstream`
- **ç›®çš„**ï¼šè®©æœ¬åœ°ä¸ä¸Šæ¸¸ä¿æŒä¸€è‡´
- **ç»“æœ**ï¼šæœ¬åœ°å®Œå…¨å¤åˆ¶ä¸Šæ¸¸çš„çŠ¶æ€

**æ¨é€** (ä»æœ¬åœ°åˆ°è¿œç¨‹)

- **å«ä¹‰**ï¼šä¸Šæ¸¸/è¿œç¨‹ â† æœ¬åœ°
- **æ“ä½œ**ï¼š`git push origin` æˆ– `git push upstream`
- **ç›®çš„**ï¼šè®©è¿œç¨‹ä¸æœ¬åœ°ä¿æŒä¸€è‡´
- **ç»“æœ**ï¼šè¿œç¨‹å®Œå…¨å¤åˆ¶æœ¬åœ°çš„çŠ¶æ€

**å…³é”®æè¿°åŸåˆ™**ï¼š

- "ä»ä¸Šæ¸¸åŒæ­¥åˆ°æœ¬åœ°" - æ­£ç¡®
- "è®©æœ¬åœ°ä¸ä¸Šæ¸¸ä¿æŒä¸€è‡´" - æ­£ç¡®
- "åŒæ­¥ä¸Šæ¸¸åˆ°æœ¬åœ°" - æ­£ç¡®
- é¿å…ä½¿ç”¨å¯èƒ½å¼•èµ·æ–¹å‘æ··æ·†çš„æè¿°

**ç¤ºä¾‹æ“ä½œè®°å½•**ï¼š

- 2025-12-17: åˆ é™¤æœ¬åœ° dev æ ‡ç­¾ï¼Œç„¶åä»ä¸Šæ¸¸åŒæ­¥æ ‡ç­¾åˆ°æœ¬åœ°ï¼Œä½¿æœ¬åœ°æ ‡ç­¾ä¸ä¸Šæ¸¸ä¿æŒä¸€è‡´
- æ­£ç¡®æè¿°ï¼š"æœ¬åœ°ä»ä¸Šæ¸¸åŒæ­¥æ ‡ç­¾"
- é”™è¯¯æè¿°ï¼š"åŒæ­¥ä¸Šæ¸¸åˆ°æœ¬åœ°"ï¼ˆæ–¹å‘æ¨¡ç³Šï¼‰

## CI/CD æµæ°´çº¿é›†æˆ

#### GitHub Actions é…ç½®

```yaml
# .github/workflows/deploy.yml
name: Deploy MoonTV

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm typecheck
      - run: pnpm test
      - run: pnpm build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            stardm0/moontv:latest
            stardm0/moontv:${{ github.sha }}

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster moontv-cluster \
            --service moontv-service \
            --force-new-deployment
```

## è¿ç»´æ–‡æ¡£ç®¡ç†

### è¿ç»´çŸ¥è¯†åº“ç»“æ„

```
ops-knowledge-base/
â”œâ”€â”€ incident-response/
â”‚   â”œâ”€â”€ incident-001.md      # æ•…éšœäº‹ä»¶è®°å½•
â”‚   â”œâ”€â”€ incident-002.md
â”‚   â””â”€â”€ playbooks/           # åº”æ€¥é¢„æ¡ˆ
â”œâ”€â”€ procedures/
â”‚   â”œâ”€â”€ deployment.md        # éƒ¨ç½²æµç¨‹
â”‚   â”œâ”€â”€ backup-recovery.md   # å¤‡ä»½æ¢å¤æµç¨‹
â”‚   â”œâ”€â”€ scaling.md          # æ‰©ç¼©å®¹æµç¨‹
â”‚   â””â”€â”€ maintenance.md      # ç»´æŠ¤æµç¨‹
â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ dashboards/         # ç›‘æ§é¢æ¿é…ç½®
â”‚   â”œâ”€â”€ alerts/            # å‘Šè­¦è§„åˆ™
â”‚   â””â”€â”€ metrics/           # ç›‘æ§æŒ‡æ ‡å®šä¹‰
â”œâ”€â”€ security/
â”‚   â”œâ”€â”€ audit/             # å®‰å…¨å®¡è®¡è®°å½•
â”‚   â”œâ”€â”€ compliance/        # åˆè§„æ€§æ–‡æ¡£
â”‚   â””â”€â”€ policies/          # å®‰å…¨ç­–ç•¥
â””â”€â”€ tools/
    â”œâ”€â”€ scripts/           # è¿ç»´è„šæœ¬
    â”œâ”€â”€ templates/         # é…ç½®æ¨¡æ¿
    â””â”€â”€ cheatsheets/       # å¿«é€Ÿå‚è€ƒæ‰‹å†Œ
```

### è¿ç»´äº¤æ¥æ–‡æ¡£

```markdown
# è¿ç»´äº¤æ¥æ–‡æ¡£

## ç³»ç»Ÿæ¦‚å†µ

- **ç³»ç»Ÿåç§°**: MoonTV
- **å½“å‰ç‰ˆæœ¬**: 3.6.2
- **éƒ¨ç½²ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ
- **æœåŠ¡çŠ¶æ€**: è¿è¡Œæ­£å¸¸

## å…³é”®ä¿¡æ¯

### è®¿é—®ä¿¡æ¯

- ç®¡ç†åå°: https://moontv.example.com/admin
- ç®¡ç†å‘˜è´¦å·: admin
- TVBox é…ç½®åœ°å€: https://moontv.example.com/api/tvbox/config

### æœåŠ¡å™¨ä¿¡æ¯

- ä¸»æœº: moontv-prod-01 (192.168.1.100)
- SSH ç«¯å£: 2222
- SSH å¯†é’¥: ~/.ssh/moontv-prod.pem

### æ•°æ®åº“ä¿¡æ¯

- Redis: localhost:6379
- å¯†ç : (å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­)

## æ—¥å¸¸è¿ç»´ä»»åŠ¡

### æ¯æ—¥æ£€æŸ¥

1. è¿è¡Œ `./scripts/daily-check.sh`
2. æ£€æŸ¥ç›‘æ§é¢æ¿
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### æ¯å‘¨ç»´æŠ¤

1. è¿è¡Œ `./scripts/weekly-maintenance.sh`
2. æ›´æ–°ç³»ç»Ÿè¡¥ä¸
3. æ¸…ç†æ—¥å¿—æ–‡ä»¶

### æ¯æœˆä»»åŠ¡

1. è¿è¡Œ `./scripts/monthly-audit.sh`
2. å®‰å…¨æ‰«æ
3. æ€§èƒ½ä¼˜åŒ–

## ç´§æ€¥è”ç³»äºº

### æŠ€æœ¯æ”¯æŒ

- å¼ ä¸‰: 138-xxxx-xxxx (ä¸»è¦è”ç³»äºº)
- æå››: 139-xxxx-xxxx (å¤‡ä»½è”ç³»äºº)

### æœåŠ¡å•†

- äº‘æœåŠ¡å•†: AWS (å·¥å•ç³»ç»Ÿ)
- åŸŸåæœåŠ¡å•†: Cloudflare
- CDN æœåŠ¡å•†: Cloudflare CDN

## æ•…éšœå¤„ç†æµç¨‹

### å¸¸è§æ•…éšœ

1. åº”ç”¨æ— æ³•å¯åŠ¨: å‚è€ƒæ–‡æ¡£ `incident-response/incident-001.md`
2. æ€§èƒ½ä¸‹é™: å‚è€ƒæ–‡æ¡£ `incident-response/incident-002.md`
3. æ•°æ®ä¸ä¸€è‡´: å‚è€ƒæ–‡æ¡£ `incident-response/incident-003.md`

### ç´§æ€¥æ¢å¤

1. å¤‡ä»½æ¢å¤: `./scripts/restore.sh latest`
2. æœåŠ¡é‡å¯: `docker-compose restart`
3. å›æ»šç‰ˆæœ¬: `git checkout v3.6.1 && docker-compose up -d`

## å˜æ›´è®°å½•

### æœ€è¿‘å˜æ›´

- 2025-12-09: å‡çº§åˆ° v3.6.2
- 2025-12-06: ä¼˜åŒ– Docker æ„å»ºé…ç½®
- 2025-12-05: å‡çº§æ—¥å¿—ç³»ç»Ÿ

### è®¡åˆ’å˜æ›´

- 2025-12-20: è®¡åˆ’æ•°æ®åº“è¿ç§»
- 2025-12-25: è®¡åˆ’å®‰å…¨å®¡è®¡
- 2026-01-01: è®¡åˆ’ç‰ˆæœ¬å‡çº§åˆ° v3.7.0
```

## æ›´æ–°å†å²

- 2025-12-12: åˆ›å»ºè¿ç»´æŒ‡å—è®°å¿†æ–‡ä»¶ï¼ŒåŸºäºé¡¹ç›®è®°å¿†ç®¡ç†å™¨æ–°è§„åˆ™é‡æ„
- 2025-12-09: æ›´æ–°ç›‘æ§é…ç½®å’Œå‘Šè­¦è§„åˆ™
- 2025-12-06: ä¼˜åŒ–å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
- 2025-12-05: å®Œå–„æ€§èƒ½ä¼˜åŒ–æŒ‡å—
- 2025-11-25: å»ºç«‹å®‰å…¨è¿ç»´æµç¨‹
- 2025-11-01: åˆ›å»ºæ—¥å¸¸ç»´æŠ¤æ£€æŸ¥æ¸…å•
- 2025-10-20: å»ºç«‹åŸºç¡€è¿ç»´ä½“ç³»æ¶æ„
- 2025-10-01: åˆ¶å®šåˆå§‹è¿ç»´è§„èŒƒå’Œæµç¨‹
